# 脚手架项目搭建日记

## 目标：提高前端的研发效能

- 前端研发核心流程：项目初始化 => 研发阶段 => 测试环境（发布） => 生产环境
- 核心：人为操作 => 流程标准化（简单的说就是自动化）
- 项目初始化流程的标准化：提供统一的模版选择 => 初始化项目(代码风格的标准化/commit 标准化/npm run release)
- 测试环境发布流程的标准化：选择发布环境 => 部署过程 => 成功 => 生成部署前后文件差异日志
- 生产环境发布流程的标准化： 项目里使用 npm release-it , 配置 .release-it.json； github 上配置 tag 触发自动构建。

## 技术选型

node + typescript + rollup

## 目录结构

```bash
├── .husky                      # git hooks钩子，commit 时校验
├── .vscode                     # vscode 自定义工作区
├── bin                         # 脚手架入口
├── lib                         # 打包后源码
├── src # 源码目录
│   ├── commands                # 命令实现
│   │   ├── add.ts              # fe add 增加模板
│   │   ├── create.ts           # fe create <project-name> 项目初始化
│   │   └── list.ts             # fe list 查看模板
│   ├── common                  # 公用
│   ├── enum                    # 枚举值
│   ├── utils                   # 工具函数
│   ├── index.ts                # 入口
│   └── main.ts                 # 主要逻辑
├── .eslintrc.js                # eslint 配置
├── .gitignore                  # git忽略文件
├── .prettierrc                 # prettier 配置
├── commitlint.config.js        # commitlint 配置
├── package.json                # Node.js manifest
├── README.md                   # 文档说明
├── rollup.config.js            # rollup 打包配置
├── rollup.dev.config.js        # rollup 开发打包配置

```

## 项目初始化和制定规范

### ts + rollup

使用 ts 开发，rollup 打包成 commonjs 模块

```ts
rollup.dev.config.js;
```

### eslint + prettierrc

vscode 需安装 eslint 和 prettierrc 插件

- [eslint-config-alloy](https://github.com/AlloyTeam/eslint-config-alloy#typescript)

配置文件`.eslintrc.js`

- `.prettierrc.js`

### 新版 husky + lint-staged + commit 规范

- 1、安装 husky

```bash
npm i husky --save-dev
```

- 2、在 package.json 中添加 prepare 脚本

```ts
{
  "scripts": {
    "prepare": "husky install"
  }
}
```

- 3、执行 prepare 脚本

```bash
npm run prepare
# 执行 husky install命令，该命令会在根目录创建.husky/目录
```

- 4、运行以下命令

```bash
npx husky add .husky/pre-commit "npm run lint"
```

- 5、添加 commit-msg 脚本

```bash
npx husky add .husky/commit-msg 'npx --no-install commitlint --edit "$1"'
```

- 6、安装 lint-staged，并在 package.json 文件中配置 lint 的命令

```bash
npm i lint-staged --save-dev
```

```ts
{
  "scripts": {
    "lint": "lint-staged",
  }
}
```

- 7、进行 lint-staged 配置

```ts
// 方法一：package.json 中配置
"lint-staged": {
  "src/**/*.(js|ts)": [
    "npx prettier --write",
    "eslint --ext .js,.tsx,.ts,.jsx src"
  ]
}
```

```ts
// 方法二：跟目录新建lint-staged.config.js文件配置
"use strict";
module.exports = {
  ignore: ["package-lock.json"],
  linters: {
    "src/**/*.(js|ts)":[
      "npx prettier --write",
      "eslint --ext .js,.tsx,.ts,.jsx src"
    ]
}
```

- 8、定制提交规范

```bash
npm install --save-dev @commitlint/config-conventional @commitlint/cli
```

```ts
// 根目录 commitlint.config.js / .commitlintrc.js
module.exports = {
  extends: ['@commitlint/config-conventional'],
  rules: {
    'type-enum': [2, 'always', ['upd', 'feat', 'fix', 'refactor', 'docs', 'chore', 'style', 'revert']],
    'type-case': [0],
    'type-empty': [0],
    'scope-empty': [0],
    'scope-case': [0],
    'subject-full-stop': [0, 'never'],
    'subject-case': [0, 'never'],
    'header-max-length': [0, 'always', 72],
  },
};
```

### 正式环境标准化发布流程

思路：代码合并到 mian 主分支 => 借助 release-it 自动打 tag，生成 CHANGELOG.md, => github 仓库上配置 tag 触发构建

```bash
# tag自动化：建议在模版上做好这一步
# 安装依赖
npm i release-it @release-it/conventional-changelog --save-dev
# 项目根目录 新建 .release-it.json
{
  "git": {
    "commitMessage": "chore: release v${version}",
    "tagName": "v${version}"
  },
  "github": {
    "release": true
  },
  "plugins": {
    "@release-it/conventional-changelog": {
      "infile": "CHANGELOG.md",
      "preset": {
        "name": "conventionalcommits",
        "types": [
          {
            "type": "feat",
            "section": "Features"
          },
          {
            "type": "fix",
            "section": "Bug Fixes"
          },
          {}
        ]
      }
    }
  }
}
# 配置脚本 package.json
"scripts": {
  "release": "release-it",
},

# 发布
# patch 1.0.0 => 1.0.1
npm run release -- patch

# minor 1.0.0 => 1.1.0
npm run release -- minor

# major 1.0.0 => 2.0.0
npm run release -- major
```
